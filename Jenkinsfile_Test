pipeline {
    agent any

    environment {
        KATALON_IMAGE = "katalonstudio/katalon"  // Docker image chính thức
        PROJECT_PATH = "/workspace/demo_cicd_katalon"  // path container map với workspace
        TEST_SUITE = "Test Suites/TS_demo_01"  // Test Suite muốn chạy
        REPORT_PATH = "Reports"  // nơi lưu báo cáo
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checkout source code from GitHub...'
                checkout scm
            }
        }

        stage('Run Katalon Tests') {
            steps {
                echo 'Running Katalon Test Suite inside Docker...'
                script {
                    docker.image("${KATALON_IMAGE}:latest").inside("-u root:root -v $WORKSPACE:$PROJECT_PATH") {
                        sh """
                            katalon-execute.sh \
                            -browserType=Chrome \
                            -projectPath=${PROJECT_PATH} \
                            -retry=0 \
                            -testSuitePath='${TEST_SUITE}' \
                            -executionProfile='default' \
                            -reportFolder=${PROJECT_PATH}/${REPORT_PATH} \
                            -consoleLog
                        """
                    }
                }
            }
        }

        stage('Archive Reports') {
            steps {
                echo 'Archiving Katalon reports...'
                archiveArtifacts artifacts: "${REPORT_PATH}/**", allowEmptyArchive: true
            }
        }
    }

    post {
        success {
            echo 'Katalon tests completed successfully!'
        }
        failure {
            echo 'Katalon tests failed!'
        }
    }
}
